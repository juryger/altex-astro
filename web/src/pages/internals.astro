---
import { CacheManager } from '@/lib/cqrs/src';
import BaseLayout from '../layouts/BaseLayout.astro';

const cacheManager = CacheManager.instance({});

const pageTitle = "–°–∏—Å—Ç–µ–º–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ";
const titleQueryCache = "–ö—ç—à –∑–∞–ø—Ä–æ—Å–æ–≤";
const titleQueryCacheOf = "–∏–∑";
const titleBrowserCache = "–ö—ç—à –±—Ä–∞—É–∑–µ—Ä–∞";
const titleCatalogReplica = "–ò–Ω—Å—Ç–∞–Ω—Å —Ä–µ–ø–ª–∏–∫–∏";
const titleRevalidateQueryCache = "–û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞—Ç—å";
const titleResetCache = "–°–±—Ä–æ—Å–∏—Ç—å";
---

<BaseLayout title={pageTitle}>
	<section class="px-4 text-center">
		<div class="stats bg-base-100 border-base-300 border">
			<div class="stat">
				<div class="stat-figure text-info">
					<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="size-7">
						<path stroke-linecap="round" stroke-linejoin="round" d="m3.75 13.5 10.5-11.25L12 10.5h8.25L9.75 21.75 12 13.5H3.75Z" />
					</svg>
				</div>
				<div class="stat-title">{titleQueryCache}</div>
				<div class="stat-value text-primary">{cacheManager.getSize()} {titleQueryCacheOf} {cacheManager.getSizeLimit()}</div>				
				<div class="stat-actions">
					<button data-query-cache-revalidate class="btn btn-xs btn-secondary" class:list={[{'btn-disabled': !cacheManager.containsInvalid()}]}>{titleRevalidateQueryCache}</button>
					<button data-query-cache-reset class="btn btn-xs btn-secondary" class:list={[{'btn-disabled': cacheManager.getSize() === 0}]}>{titleResetCache}</button>
				</div>
			</div>

			<div class="stat">
				<div class="stat-figure text-info">
					<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="size-6">
						<path stroke-linecap="round" stroke-linejoin="round" d="M12 21a9.004 9.004 0 0 0 8.716-6.747M12 21a9.004 9.004 0 0 1-8.716-6.747M12 21c2.485 0 4.5-4.03 4.5-9S14.485 3 12 3m0 18c-2.485 0-4.5-4.03-4.5-9S9.515 3 12 3m0 0a8.997 8.997 0 0 1 7.843 4.582M12 3a8.997 8.997 0 0 0-7.843 4.582m15.686 0A11.953 11.953 0 0 1 12 10.5c-2.998 0-5.74-1.1-7.843-2.918m15.686 0A8.959 8.959 0 0 1 21 12c0 .778-.099 1.533-.284 2.253m0 0A17.919 17.919 0 0 1 12 16.5c-3.162 0-6.133-.815-8.716-2.247m0 0A9.015 9.015 0 0 1 3 12c0-1.605.42-3.113 1.157-4.418" />
					</svg>
				</div>
				<div class="stat-title">{titleBrowserCache}</div>
				<div class="stat-value text-primary">2.6M</div>
				<div class="stat-actions">
					<button data-browser-cache-reset class="btn btn-xs btn-secondary">{titleResetCache}</button>
					<span class="stat-desc">(next check: [date-time])</span>
				</div>
			</div>

			<div class="stat">
				<div class="stat-figure text-info">
					<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="size-7">
						<path stroke-linecap="round" stroke-linejoin="round" d="M20.25 6.375c0 2.278-3.694 4.125-8.25 4.125S3.75 8.653 3.75 6.375m16.5 0c0-2.278-3.694-4.125-8.25-4.125S3.75 4.097 3.75 6.375m16.5 0v11.25c0 2.278-3.694 4.125-8.25 4.125s-8.25-1.847-8.25-4.125V6.375m16.5 0v3.75m-16.5-3.75v3.75m16.5 0v3.75C20.25 16.153 16.556 18 12 18s-8.25-1.847-8.25-4.125v-3.75m16.5 0c0 2.278-3.694 4.125-8.25 4.125s-8.25-1.847-8.25-4.125" />
					</svg>
				</div>
				<div class="stat-title">{titleCatalogReplica}</div>
				<div class="stat-value text-primary">Initial</div>
				<div class="stat-desc">(created at: [date-time])</div>
			</div>
		</div>
	</div>
</BaseLayout>

<script>
	import { getErrorMessage } from "@/lib/domain/src";
	import { actions } from "astro:actions";
	import { navigate } from "astro:transitions/client";

	const controller: AbortController = new AbortController();

	const assingEventHandlers = (signal: AbortSignal) => {
		// Query Cache revalidate 
		const buttonCacheRevalidate = document.querySelector('[data-query-cache-revalidate]');
		buttonCacheRevalidate?.addEventListener('click', async () => { 		
			console.log("üß™ ~ internals ~ prepare to revalidate query cache");
			const result = await actions.internalsActions.revalidateQueryCache();		
			if (result.error) {
				const errorMessage = getErrorMessage(result.error);
				console.error(errorMessage);
				return;
			}
			console.log("üß™ ~ internals ~ query cache revalidate, result:", result);
			if (result.data) navigate(`/internals`);
		}, { signal });

		// Query Cache reset 
		const buttonCacheReset = document.querySelector('[data-query-cache-reset]');
		buttonCacheReset?.addEventListener('click', async () => {
			console.log("üß™ ~ internals ~ prepare to reset query cache");
			const result = await actions.internalsActions.resetQueryCache();
			if (result.error) {
				const errorMessage = getErrorMessage(result.error);
				console.error(errorMessage);
				return;
			}
			console.log("üß™ ~ internals ~ query cache reset, result:", result);
			navigate(`/internals`);
		}, { signal });
	}

	assingEventHandlers(controller.signal);

	window.addEventListener('beforeunload', () => { 
    // This instantly removes all listeners using 'signal' from themeToggleManager
    controller?.abort(); 
  });

  window.addEventListener('pagehide', () => {     
    // This instantly removes all listeners using 'signal' from themeToggleManager
    controller?.abort(); 
  });
</script>