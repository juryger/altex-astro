---
export const prerender = false;

import BaseLayout from '@/web/src/layouts/BaseLayout.astro';
import { getProduct } from '@/web/src/core/utils/live-collection-manager';
import type { Product } from '@/web/src/core/models/product';
import ProductDetails from '@/web/src/components/catalog/ProductDetails.astro';
import { getSessionManager } from '@/web/src/core/utils/session-manager';

const { slug } = Astro.params;

let product: Product | undefined;
const sessionManager = getSessionManager(Astro.session);

try {
  if (slug !== undefined) product = await getProduct(slug);
} catch(error) {
  console.error("ðŸ›‘ ~ Product page ~ failed to fetch product", error);
}

if (product === undefined)
{
  sessionManager.resetActiveCatalogItem();
  return Astro.redirect("/404");
}

console.log("ðŸŒŽ ~ Product page ~ product", product);
sessionManager.setActiveCatalogItem({ 
  parentCategory: undefined,
  category: { slug: product.categorySlug, title: product.categoryTitle }, 
  product: { slug: product.slug, title: product.title }
});
---

<BaseLayout title=`ÐšÐ°Ñ‚Ð°Ð»Ð¾Ð³ - ${product?.title}`>
    <div id="product-container" class="px-4">
      {product && 
        <ProductDetails item={product} />
      }
    </div>
</BaseLayout>