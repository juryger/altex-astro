---
export const prerender = false;

import BaseLayout from '@/web/src/layouts/BaseLayout.astro';
import { type Category } from '@/web/src/core/models/category';
import { getCategory } from '@/web/src/core/utils/live-collection-manager';
import Categories from '@/web/src/components/catalog/Categories.astro';
import Products from '@/web/src/components/catalog/Products.astro';
import CollectionFallback from '@/web/src/components/CollectionFallback.astro';
import getRouteParser from '@/web/src/core/utils/route-parser';
import { getSessionManager } from '@/web/src/core/utils/session-manager';
import type { Sorting } from '@/web/src/core/models/sorting';
import type { Paging } from '@/web/src/core/models/paging';
import type { Filtering } from '@/web/src/core/models/filtering';

const { slug, params } = Astro.params;

const parseRouteParams = (): { sorting: Sorting | undefined, paging: Paging | undefined, filtering: Filtering[] } => {
  console.log("ğŸ‘‰ parseRouteParams");
  const routeParser = getRouteParser(params);
  console.log("ğŸŒ ~ Category page ~ slug %s, params: %o", slug, params);
  const sorting = routeParser.getCatalogSorting();
  console.log("ğŸŒ ~ Categories page ~ parsed sort", sorting);
  const paging = routeParser.getCatalogPaging();
  console.log("ğŸŒ ~ Category page ~ parse paging", paging);
  const filtering = routeParser.getCatalogFiltering();
  console.log("ğŸŒ ~ Category page ~ parsed filters", filtering);
  return { sorting, paging, filtering };
}

let category: Category | undefined;
const sessionManager = getSessionManager(Astro.session);

try {
  if (slug !== undefined) category = await getCategory(slug);
} catch(error) {
  console.error("ğŸ›‘ ~ Category page ~ failed to fetch category", error);
}

if (category === undefined)
{
  sessionManager.resetActiveCatalogItem();
  return Astro.redirect("/404");
}

sessionManager.setActiveCatalogItem({ 
  parentCategory: category?.parentSlug && category?.parentTitle ? 
    { slug: category?.parentSlug, title: category?.parentTitle } 
    : undefined, 
  category: { slug: category.slug, title: category.title }, 
  product: undefined
});

const { sorting, paging, filtering } = parseRouteParams();

const subTitleCategories = "Ğ¡Ğ¿Ğ¸ÑĞ¾Ğº Ğ¿Ğ¾Ğ´ĞºĞ°Ñ‚ĞµĞ³Ğ¾Ñ€Ğ¸Ğ¹";
const subTitleProducts = "Ğ¡Ğ¿Ğ¸ÑĞ¾Ğº Ñ‚Ğ¾Ğ²Ğ°Ñ€Ğ¾Ğ²";
---

<BaseLayout title=`ĞšĞ°Ñ‚Ğ°Ğ»Ğ¾Ğ³ - ${category?.title}`>
  <Categories parentSlug={category?.slug} title={subTitleCategories} server:defer>
		<div slot="fallback" class="mx-3.5">
			<CollectionFallback title={subTitleCategories} />
		</div>
	</Categories>
	<Products categorySlug={category?.slug} sorting={sorting} paging={paging} filtering={filtering} server:defer>
		<div slot="fallback" class="mx-3.5">
			<CollectionFallback title={subTitleProducts} />
		</div>
	</Products>
</BaseLayout>