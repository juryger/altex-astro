---
export const prerender = false;

import BaseLayout from '@/web/src/layouts/BaseLayout.astro';
import { getCategory } from '@/web/src/core/utils/live-collection-manager';
import Categories from '@/web/src/components/catalog/Categories.astro';
import Products from '@/web/src/components/catalog/Products.astro';
import CollectionFallback from '@/web/src/components/CollectionFallback.astro';
import getRouteParser from '@/web/src/core/utils/route-parser';
import { getSessionManager } from '@/web/src/core/utils/session-manager';
import CategoryDetails from '@/web/src/components/catalog/CategoryDetails.astro';
import { getQueryManager, fetchMeasurementUnits, fetchDiscounts, fetchProductColors } from '@/lib/cqrs';
import type { Category, Catalog, Paging, Sorting, Filtering } from '@/lib/domain';
import { CacheKeys, EnvironmentNames, getCacheInfo, regexTrue, selectEnvironment } from '@/lib/domain';
import { defaultSorting } from "@/web/src/core/utils/sorting";

const { slug, params } = Astro.params;
const withTracing = regexTrue.test(
  selectEnvironment(EnvironmentNames.ENABLE_TRACING),
);

const parseRouteParams = (): { 
  sorting: Sorting | undefined, 
  paging: Paging | undefined,
  filtering: Filtering[]
} => {
  const routeParser = getRouteParser(params);  
  const sorting = routeParser.getCatalogSorting();
  const paging = routeParser.getCatalogPaging();
  const filtering = routeParser.getCatalogFiltering();  

  withTracing && console.log("ğŸ¾ ~ Category page ~ slug %s, params: %o", slug, params);
  withTracing && console.log("ğŸ¾ ~ Categories page ~ parsed sort", sorting);
  withTracing && console.log("ğŸ¾ ~ Category page ~ parse paging", paging);
  withTracing && console.log("ğŸŒ ~ Category page ~ parsed filters", filtering);

  return { sorting, paging, filtering };
}

const fetchCatalogReferences = async (): Promise<Catalog | undefined> => {
  const queryManager = getQueryManager();
  return await Promise.all([
    queryManager.fetch(
      () => fetchMeasurementUnits(),
      getCacheInfo(CacheKeys.MeasurementUnits),
    ), 
    queryManager.fetch(
      () => fetchDiscounts(), 
      getCacheInfo(CacheKeys.Discounts),
    ), 
    queryManager.fetch(
      () => fetchProductColors(),
      getCacheInfo(CacheKeys.ProductColors)
    ),
  ]).then((data) => {        
    if (data.some(x => x.error !== undefined)) {
      const errorMessage = data.reduce((acc, curr) => acc + `${curr.error !== undefined ? curr.error?.message + ", " : ""}`, "").slice(0, -2);
      console.error("ğŸ›‘ ~ Category page ~", errorMessage);  
      return undefined;
    }
    return {
      measurementUnits: data[0].data ?? [],
      discounts: data[1].data ?? [],
      productColors: data[2].data ?? [],
    }
  }).catch((err) => { 
    console.error("ğŸ›‘ ~ Category page ~ failed to load dictionaries (measurement units, discounts, product colors))", err);
    return undefined;
  });
}

const fetchCategory = async (): Promise<Category | undefined> => {
  let result: Category | undefined;
  try {
    if (slug !== undefined) result = await getCategory(slug);
  } catch(error) {
    console.error("ğŸ›‘ ~ Category page ~ failed to fetch category", error);
  }
  return result;
}

const sessionManager = getSessionManager(Astro.session);
const category = await fetchCategory();
if (category === undefined) {
  sessionManager.resetActiveCatalogItem();
  return Astro.redirect("/500");
}

const references = await fetchCatalogReferences();
if (references === undefined) {
  return Astro.redirect("/500");
}

sessionManager.setActiveCatalogItem({ 
  parentCategory: category?.parentSlug && category?.parentTitle ? 
    { slug: category?.parentSlug, title: category?.parentTitle } 
    : undefined, 
  category: { slug: category.slug, title: category.title }, 
  product: undefined
});

const { sorting, paging, filtering } = parseRouteParams();
const productsView = await sessionManager.getProductsView();
const newProductsView = {
    sorting: sorting !== undefined 
    ? sorting 
    : productsView?.sorting ?? defaultSorting, 
  filtering: filtering !== undefined && filtering.length > 0 
    ? filtering 
    : productsView?.filtering,
};
sessionManager.setProductsView(newProductsView);
---

<BaseLayout title=`ĞšĞ°Ñ‚Ğ°Ğ»Ğ¾Ğ³ - ${category?.title}`>
  <CategoryDetails item={category} />
  <Categories parentSlug={category?.slug} server:defer>
		<div slot="fallback" class="mx-3.5">
			<CollectionFallback />
		</div>
	</Categories>
	<Products categorySlug={category?.slug} references={references} sorting={newProductsView.sorting} paging={paging} filtering={newProductsView.filtering} server:defer>
		<div slot="fallback" class="mx-3.5">
			<CollectionFallback />
		</div>
	</Products>
</BaseLayout>