---
import CartSidebar from "./CartSidebar.astro";

const titleCart = "Корзина";
const titleViewCart = "Просмотреть";
const titleCartItemsNumber = "Товаров:";
const titleCartCostSum = "На сумму:";

const sidebarId = "cart-sidebar";
const dataCartIndicatorName = "data-cartmenu-indicator";
const dataCartCountName = "data-cartmenu-count";
const dataCartDiscountedCostName = "data-cartmenu-discounted-cost";
const dataCartFullCostName = "data-cartmenu-full-cost";
const dataCartShowCommandName = "cartmenu-show";
---

<cart-menu 
  data-cartmenu_indicator={dataCartIndicatorName} 
  data-cartmenu_count={dataCartCountName} 
  data-cartmenu_discounted_cost={dataCartDiscountedCostName} 
  data-cartmenu_full_cost={dataCartFullCostName}
  data-cartmenu_show={dataCartShowCommandName}
  data-cartmenu_sidebar={sidebarId}
>
  <CartSidebar id={sidebarId} />
  <div class="dropdown dropdown-end">
    <div tabindex="0" role="button" class="btn btn-ghost btn-circle">
      <div class="indicator">
        <span data-cartmenu-indicator class="indicator-item badge badge-xs badge-info">0</span>
        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"> 
          <title>{titleCart}</title>
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" 
            d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2.293 2.293c-.63.63-.184 1.707.707 1.707H17m0 0a2 2 0 100 4 2 2 0 000-4zm-8 2a2 2 0 11-4 0 2 2 0 014 0z" /> 
        </svg>
      </div>
    </div>
    <div tabindex="0" class="card card-compact dropdown-content bg-base-300 z-1 mt-3 w-52 shadow">
      <div class="card-body p-4">
        <div class="flex flex-row gap-1">
          <span class="text-lg font-bold">{titleCartItemsNumber}</span>
          <span data-cartmenu-count class="text-lg font-bold">{0}</span>
        </div>
        <span>{titleCartCostSum}</span>
        <div class="flex flex-row gap-1">
          <span data-cartmenu-discounted-cost class="text-info font-semibold">{0}</span>
          <del data-cartmenu-full-cost class="text-info font-semibold"></del>
        </div>
        <button name="cartmenu-show" class="btn btn-primary w-full rounded-md border border-transparent">{titleViewCart}</button>
      </div>
    </div>
  </div>
</cart-menu>

<script>
  import { formatCurrency } from "../../core/utils/text-formatter";
  import { DiscountMetadata } from "../../core/models/discount";
  import { $cartCount, $cartCost, $cartWhsCost1, $cartWhsCost2 } from "../../core/stores/cart-store";
 
  class CartMenu extends HTMLElement {
    private cartIndicatorEl: Element | null = null;
    private cartCountEl: Element | null = null;
    private discountedCostEl: Element | null = null;
    private fullCostEl: Element | null = null;
    private cartShowEl: Element | null = null; 
    private sidebarEl: Element | null = null;
    private storeCountUnsubscribe?: () => void;
    private storeCostUnsubscribe?: () => void;
    private storeWhsCost1Unsubscribe?: () => void;
    private storeWhsCost2Unsubscribe?: () => void;
    private cartShowHandler: any;

    constructor() {
      super();
    }

    private onCartShowClick = () => {
      return (e: Event) => {
        e.preventDefault();
        if (this.sidebarEl !== null) (this.sidebarEl as HTMLInputElement).click();
      }
    }

    private syncCartCountFromStore(): void {
      if (!this.cartIndicatorEl || !this.cartCountEl) return;

      const totalCount = $cartCount.get();
      this.cartIndicatorEl.innerHTML = totalCount.toString();
      this.cartCountEl.innerHTML = totalCount.toString();
      if (this.cartShowEl) (this.cartShowEl as HTMLInputElement).disabled = (totalCount === 0); 
    }

    private syncCartCostFromStore(): void {
      const sum = $cartCost.get();
      const whsSum1 = $cartWhsCost1.get();
      const whsSum2 = $cartWhsCost2.get();

      if (sum >= DiscountMetadata[2]?.sum) {
        console.log("~ CartMenu ~ discount cost #2 applied:%i", sum);
        if (this.discountedCostEl !== null) this.discountedCostEl.innerHTML = formatCurrency(whsSum2);  
        if (this.fullCostEl !== null) this.fullCostEl.innerHTML = formatCurrency(sum);
      } else if (sum >= DiscountMetadata[1]?.sum) {
        console.log("~ CartMenu ~ discount cost #1 applied:%i", sum);
        if (this.discountedCostEl !== null) this.discountedCostEl.innerHTML = formatCurrency(whsSum1);  
        if (this.fullCostEl !== null) this.fullCostEl.innerHTML = formatCurrency(sum);
      } else {
        console.log("~ CartMenu ~ no discounts applied:%i", sum);
        if (this.discountedCostEl !== null) this.discountedCostEl.innerHTML = formatCurrency(sum);
        if (this.fullCostEl !== null) this.fullCostEl.innerHTML = "";
      }
    }

    private subscribeToCountStore() {
      this.storeCountUnsubscribe = $cartCount.listen((value) => {
        console.log("~ CartMenu component ~ total count has changed:", value);
        if (this.cartIndicatorEl !== null) this.cartIndicatorEl.innerHTML = value.toString();
        if (this.cartCountEl !== null) this.cartCountEl.innerHTML = value.toString();
        if (this.cartShowEl) (this.cartShowEl as HTMLInputElement).disabled = (value === 0); 
      });
    }

    private subscribeToCostStore() {
      this.storeCostUnsubscribe = $cartCost.listen((value) => {
        if (!this.discountedCostEl || !this.fullCostEl) return;

        console.log("~ CartMenu ~ full cost:%i", value);
        this.discountedCostEl.innerHTML = formatCurrency(value);
        this.fullCostEl.innerHTML = "";
      });
    }

    private subscribeToWhsCost1Store() {
      this.storeWhsCost1Unsubscribe = $cartWhsCost1.listen((value) => {
        if (!this.discountedCostEl || !this.fullCostEl) return;

        if (value >= DiscountMetadata[1]?.sum) {
          console.log("~ CartMenu ~ discount cost #1:%i", value);
          this.discountedCostEl.innerHTML = formatCurrency(value);
          this.fullCostEl.innerHTML = formatCurrency($cartCost.get());
        }
      });
    }

    private subscribeToWhsCost2Store() {
      this.storeWhsCost2Unsubscribe = $cartWhsCost2.listen((value) => {
        if (!this.discountedCostEl || !this.fullCostEl) return;

        if (value >= DiscountMetadata[2]?.sum) {
          console.log("~ CartMenu ~ discount cost #2:%i", value);
          this.discountedCostEl.innerHTML = formatCurrency(value);
          this.fullCostEl.innerHTML = formatCurrency($cartCost.get());
        }
      });
    }

    private getCartIndicatorElement = (): Element | null => {
      const dataCartIndicatorName = this.dataset.cartmenu_indicator;
      const result = this.querySelector(`[${dataCartIndicatorName}]`);
      console.assert(result !== null, "~ CartMenu ~ Cannot find element: [%s]", dataCartIndicatorName);
      return result;
    }

    private getCartCountElement = (): Element | null => {
      const dataCartCountName = this.dataset.cartmenu_count;
      const result = this.querySelector(`[${dataCartCountName}]`);
      console.assert(result !== null, "~ CartMenu ~ Cannot find element [%s]", dataCartCountName);
      return result;
    }

    private getDiscountedCostElement = (): Element | null => {
      const dataDiscountedCostName = this.dataset.cartmenu_discounted_cost;
      const result = this.querySelector(`[${dataDiscountedCostName}]`);
      console.assert(result !== null, "~ CartMenu ~ Cannot find element [%s]", dataDiscountedCostName);
      return result;
    }

    private getFullCostElement = (): Element | null => {
      const dataFullCostName = this.dataset.cartmenu_full_cost;
      const result = this.querySelector(`[${dataFullCostName}]`);
      console.assert(result !== null, "~ CartMenu ~ Cannot find element [%s]", dataFullCostName);
      return result;
    }

    private getCartShowElement = (): Element | null => {
      const dataCartShowommandName = this.dataset.cartmenu_show;
      const result = this.querySelector(`button[name='${dataCartShowommandName}']`);
      console.assert(result !== null, "Cannot find element [%s]", dataCartShowommandName);
      
      this.cartShowHandler = this.onCartShowClick();
      result?.addEventListener('click', this.cartShowHandler);
      
      return result;
    }

    private getSidebarElement = (): Element | null => {
      const sidebarElementId = this.dataset.cartmenu_sidebar;
      const result = this.querySelector(`#${sidebarElementId}`);
      console.assert(result !== null, "Cannot find element with ID: [%s]", sidebarElementId);
      return result;
    }
    
    connectedCallback() {
      this.cartIndicatorEl = this.getCartIndicatorElement();
      this.cartCountEl = this.getCartCountElement();
      this.discountedCostEl = this.getDiscountedCostElement();
      this.fullCostEl = this.getFullCostElement();
      this.cartShowEl = this.getCartShowElement();
      this.sidebarEl = this.getSidebarElement();

      this.syncCartCountFromStore();
      this.syncCartCostFromStore();

      this.subscribeToCountStore();
      this.subscribeToCostStore();
      this.subscribeToWhsCost1Store();
      this.subscribeToWhsCost2Store();
    }

    disconnectedCallback() {
      this.storeCountUnsubscribe && this.storeCountUnsubscribe();
      this.storeCostUnsubscribe && this.storeCostUnsubscribe();
      this.storeWhsCost1Unsubscribe && this.storeWhsCost1Unsubscribe();
      this.storeWhsCost2Unsubscribe && this.storeWhsCost2Unsubscribe();

      this.cartShowEl?.removeEventListener('click', this.cartShowHandler);
    }
  }

  customElements.define('cart-menu', CartMenu);
</script>