---
export const prerender = false;

import { Image } from 'astro:assets';
import type { Product } from '../../core/models/product';
import { UnitOfMeasurementDictionary } from '../../core/models/unit-of-measurement';
import ProductColors from './ProductColors.astro';
import ProductPrice from './ProductPrice.astro';
import ProductPackInfo from './ProductPackInfo.astro';
import QuantitySelector from '../QuantitySelector.astro';

interface Props {
  item: Product,
}
const { item } = Astro.props;

const btnAddToCartName = "pd-add-to-cart";
const inputQuantityName = "pd-quantity-value"
const productsBlobStorageUrl = `${import.meta.env.PUBLIC_BLOB_STORAGE_PRODUCTS_URL}`;
const unitItem = item.unit ? UnitOfMeasurementDictionary[item.unit] : UnitOfMeasurementDictionary[0];
console.log("üõ†Ô∏è ~ ProductDetails component ~ blob storage url %s, unitOfMeasurement: %s", productsBlobStorageUrl, unitItem.title)

const noProductDescription = "–ù–µ—Ç –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ —Ç–æ–≤–∞—Ä–µ";
const titleAddToCart = "–í –∫–æ—Ä–∑–∏–Ω—É";
---

<product-details 
  data-btn_add_to_cart={btnAddToCartName} data-input_quatnity={inputQuantityName}
  data-id={item.id} data-product_code={item.productCode} data-title={item.title} data-colors={JSON.stringify(item.colors)} 
  data-price={item.price} data-whs_price1={item.whsPrice1} data-whs_price2={item.whsPrice2} 
  data-category_id={item.categoryId} data-category_slug={item.categorySlug}
  data-image={item.image} data-slug={item.slug}
>
  <div class="grid grid-cols-1 gap-2 sm:gap-6 sm:grid-cols-2 px-2 py-2">
    <div>
      {/* Product code */}
      <div class="flex flex-row justify-end">
        <span class="text-xs italic \">–ê—Ä—Ç–∏–∫—É–ª:</span>
        <span class="text-xs italic ml-1">{item.productCode}</span>
      </div>
      {/* Gallery */}
      <figure class="bg-base-100 aspect-square w-full object-cover lg:aspect-auto h-[500px]">
        <Image src=`${productsBlobStorageUrl}/${item.image}` alt=`${item.title}` width="500" height="500" class="rounded-xl"/>
      </figure>
    </div>
    <div class="px-2 py-2">
      <h1 class="font-bold text-lg mb-2">{item.title}</h1>
      {/* Descirption */}
      <div class="py-3">
        {(item.description && item.description.length > 0) 
          ? <span>{item.description}</span>
          : <span class="italic">{noProductDescription}</span>
        }
      </div>
      {/* Prices */}
      <ProductPrice price={item.price} whsPrice1={item.whsPrice1} whsPrice2={item.whsPrice2} isDetailed={true} />
      {/* Packaging info */}
      <ProductPackInfo quantityInPack={item.quantityInPack} minQuantityToBuy={item.minQuantityToBuy} unitOfMeasurementTitle={unitItem.title} />
      {/* Available colors */}
      <ProductColors productId={item.id} colors={item.colors} isDetailed={true} />  
      {/* Add to Shopping Cart */}
      <div class="flex items-center mt-5">
        <QuantitySelector inputControlName={inputQuantityName} quantity={1} />
        <button name={btnAddToCartName} class="btn btn-active btn-primary ml-4">{titleAddToCart}</button>
      </div>
    </div>
  </div>
</product-details>

<script>
  import type { Product } from "../../core/models/product";
  import { parseProduct } from "../../core/utils/data-attributes-parser";
  import type { CartItem } from "../../core/models/cart";
  import { addAlert } from "../../core/stores/alert-store";
  import { AlertKind } from "../../core/models/alert";
  import { addToCart } from "../../core/stores/cart-store";
  import { CartMessages } from "../../core/const/messages";

  class ProductDetails extends HTMLElement {
    private value: Product | undefined;
    private addToCartHandler: any | undefined;

    private onAddToCart = (): any => {
      return (e: Event): void => {
        if (!this.value) {
          console.warn("~ ProductDetails ~ cannot add product to the cart as it values was not parsed properly.")
          return;
        }

        const selectedColorEl =  this.querySelector('input[type=radio]:checked');
        var selectedColor = selectedColorEl ? (selectedColorEl as HTMLInputElement).value : null;
        
        const radioboxes = this.querySelectorAll('input[type=radio]')
        if (!selectedColor && radioboxes.length > 0) {
          selectedColor = (radioboxes[0] as HTMLInputElement).value;
        }
        
        const inputQuantityName = this.dataset.input_quatnity;
        var quanityEl = this.querySelector(`input[name='${inputQuantityName}']`);
        console.assert(quanityEl !== null, "~ ProductDetails ~ cannot find input element with name: %s", inputQuantityName);
        
        const color = selectedColor !== null ? parseInt(selectedColor) : undefined;
        const quantity = quanityEl ? parseInt((quanityEl as HTMLInputElement).value) : 1;

         addToCart({
          productId: this.value.id,
          productCode: this.value.productCode,
          title: this.value.title,
          availableColors: this.value.colors,
          price: this.value.price,
          whsPrice1: this.value.whsPrice1,
          whsPrice2: this.value.whsPrice2,
          image: this.value.image,
          slug: this.value.slug,
          color: color,
          quantity: quantity
        } as CartItem);

        addAlert({ 
          kind: AlertKind.Info, 
          message: CartMessages.AddedToTheCart
        });
      }
    }
    
    connectedCallback() {
      this.value = parseProduct(this.dataset);
      if (!this.value) {
        console.warn(`~ ProductDetails ~ provided values of product via data attributes are not valid or complete.`);
        return;
      }
      
      this.addToCartHandler = this.onAddToCart();

      const btnAddToCartName = this.dataset.btn_add_to_cart;
      const button = this.querySelector(`button[name='${btnAddToCartName}']`);
      console.assert(button !== null, "~ ProductDetails ~ cannot find button element with name: %s", btnAddToCartName);

      button?.addEventListener('click', this.addToCartHandler);
    }

    disconnectedCallback() {
      const btnAddToCartName = this.dataset.btn_add_to_cart;
      const button = this.querySelector(`button[name='${btnAddToCartName}']`);
      this.addToCartHandler && button && button.removeEventListener('click', this.addToCartHandler);
    }
  }
  customElements.define('product-details', ProductDetails);
</script>