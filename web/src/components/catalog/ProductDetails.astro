---
import { Image } from 'astro:assets';
import type { Product } from '@/web/src/core/models/product';
import ProductColors from './ProductColors.astro';
import ProductPrice from './ProductPrice.astro';
import ProductPackInfo from './ProductPackInfo.astro';
import QuantitySelector from '../QuantitySelector.astro';
import { trimEnd } from '@/web/src/core/utils/text-formatter';
import ProductMake from './ProductMake.astro';
import ProductDimensions from './ProductDimensions.astro';
import type { Catalog } from '@/lib/domain/';

interface Props {
  item: Product;
  references: Catalog;
  isPreview?: boolean;
}
const { item, references, isPreview } = Astro.props;

const unitItem = references.measurementUnits.find(x => x.id === item.unitId);
if (unitItem === undefined) {
  console.warn("~ ProductDetails ~ unable to obtain reference of measurement unit with Id", item.unitId);
}

const btnAddToCartName = "pd-add-to-cart";
const inputQuantityName = "pd-quantity-value"

const titleNoProductDescription = "Нет дополнительной информации о товаре";
const titleAddToCart = "В корзину";
const titleProductCode = "Артикул";
const titleUnknown = "(?)";
---

<product-details 
  data-btn_add_to_cart={btnAddToCartName} data-input_quatnity={inputQuantityName}
  data-id={item.id} data-product_code={item.productCode} data-title={item.title} data-colors={JSON.stringify(item.colors)} 
  data-price={item.price} data-whs_price1={item.whsPrice1} data-whs_price2={item.whsPrice2} 
  data-category_id={item.categoryId} data-category_slug={item.categorySlug}
  data-image={item.imageUrl} data-thumbnail-image={item.thumbnailImageUrl} data-slug={item.slug}
>
  <div class="grid grid-cols-1 gap-2 sm:gap-6 sm:grid-cols-2 px-2 py-2">
    <div>
      {/* Product code */}
      <div class="flex flex-row justify-end">
        <span class="text-xs italic \">{titleProductCode}:</span>
        <span class="text-xs italic ml-1">{item.productCode}</span>
      </div>
      {/* Gallery */}
      <figure class="bg-base-100 aspect-square w-full object-cover lg:aspect-auto h-[37.5] md:h-[125]">
        <Image src=`${item.imageUrl}` alt=`${item.title}` width="500" height="500" class="rounded-xl h-[37.5] md:h-[125] object-contain" />
      </figure>
    </div>
    <div class="flex flex-col gap-2">
      <div>
        {isPreview && 
          <a href=`/catalog/products/${item.slug}`>
            <div class="flex flex-row align-top">
              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="size-5 pt-1">
                <path stroke-linecap="round" stroke-linejoin="round" d="M13.19 8.688a4.5 4.5 0 0 1 1.242 7.244l-4.5 4.5a4.5 4.5 0 0 1-6.364-6.364l1.757-1.757m13.35-.622 1.757-1.757a4.5 4.5 0 0 0-6.364-6.364l-4.5 4.5a4.5 4.5 0 0 0 1.242 7.244" />
              </svg>
              <h1 class="card-title text-lg font-bold pl-1" title={item.title}>
                {trimEnd(item.title, 100)} 
              </h1>
            </div>
          </a>
        }
        {!isPreview &&
          <h1 class="card-title text-lg font-bold" title={item.title}>
            {trimEnd(item.title, 100)} 
          </h1>
        }
      </div>
      {/* Descirption */}
      <div class="py-2">
        {(item.description && item.description.length > 0) 
          ? <span>{item.description}</span>
          : <span class="italic text-sm">{titleNoProductDescription}</span>
        }
      </div>
      <ProductPrice price={item.price} whsPrice1={item.whsPrice1} whsPrice2={item.whsPrice2} discounts={references.discounts} isDetailed={true} />
      <ProductPackInfo quantityInPack={item.quantityInPack} minQuantityToBuy={item.minQuantityToBuy} unitOfMeasurement={unitItem?.title ?? titleUnknown} />
      <ProductMake maker={item.maker} makeCountry={item.makeCountry} />
      <ProductDimensions length={item.dimensionLengthMm} width={item.dimensionWidthMm} height={item.dimensionHeightMm} />
      <ProductColors productId={item.id} colors={item.colors} colorsReference={references.productColors} isDetailed={true} />  
      {/* Add to Shopping Cart */}
      <div class="flex items-center justify-center md:justify-start my-4">
        <QuantitySelector inputControlName={inputQuantityName} quantity={1} />
        <button name={btnAddToCartName} class="btn btn-active btn-primary ml-4">{titleAddToCart}</button>
      </div>
    </div>
  </div>
</product-details>

<script>
  import type { Product } from "@/web/src/core/models/product";
  import { parseProduct } from "@/web/src/core/utils/data-attributes-parser";
  import type { CartItem } from "@/web/src/core/models/cart";
  import { addAlert } from "@/web/src/core/stores/alert-store";
  import { AlertKind } from "@/web/src/core/const";
  import { addToCart } from "@/web/src/core/stores/cart-store";
  import { CartMessages } from "@/web/src/core/const/messages";
  import { getButtonElementByName, getInputElementByName } from "@/web/src/core/utils/dom-utils";
  import type { ProductColor } from "@/web/src/core/models/product-color";
  import { clientDb } from '@/web/src/core/db/indexed-db';
  import { NO_VALUE_ASSIGNED } from "@/web/src/core/const";

  class ProductDetails extends HTMLElement {
    private addToCartEl: Element | null = null;
    private value: Product | undefined;
    private controller: AbortController | undefined;
    private productColors: Array<ProductColor> = [];

    private onAddToCart = (): void => {
      if (!this.value) {
        console.warn("~ ProductDetails ~ cannot add product to the cart as it values was not parsed properly.")
        return;
      }

      const selectedColorEl =  this.querySelector('input[type=radio]:checked');
      var selectedColor = selectedColorEl ? (selectedColorEl as HTMLInputElement).value : null;
      
      if (selectedColor === null) {
        const radioboxes = this.querySelectorAll('input[type=radio]')
        selectedColor = radioboxes.length > 0 ? (radioboxes[0] as HTMLInputElement).value : null;
      }
      
      const quanityEl = getInputElementByName(this, this.dataset.input_quatnity);
      
      const color = selectedColor !== null ? parseInt(selectedColor) : undefined;
      const colorTitle = this.productColors.find(x => x.id === color)?.title ?? NO_VALUE_ASSIGNED;
      const quantity = quanityEl ? parseInt((quanityEl as HTMLInputElement).value) : 1;

      addToCart({
        productId: this.value.id,
        productCode: this.value.productCode,
        title: this.value.title,
        availableColors: this.value.colors,
        price: this.value.price,
        whsPrice1: this.value.whsPrice1,
        whsPrice2: this.value.whsPrice2,
        image: this.value.thumbnailImageUrl,
        slug: this.value.slug,
        color,
        colorTitle,
        quantity
      } as CartItem);

      addAlert({ 
        kind: AlertKind.Info, 
        message: CartMessages.AddedToTheCart
      });
    }

    private loadProductColorsFromIndexedDB(): void {
      if (this.productColors.length > 0) return;

      clientDb.productColors.toArray((data) => { 
        if (data.length === 0) {
          console.warn("~ ProductDetails ~ Product Colors data are not available.");
          return;
        }
        this.productColors = data;
      });
    }

    connectedCallback() {
      this.controller = new AbortController();
      this.loadProductColorsFromIndexedDB();

      this.value = parseProduct(this.dataset);
      if (!this.value) {
        console.warn(`~ ProductDetails ~ provided values of product via data attributes are not valid or complete.`);
        return;
      }
      
      this.addToCartEl = getButtonElementByName(this, this.dataset.btn_add_to_cart);
      this.addToCartEl?.addEventListener('click', this.onAddToCart, { signal: this.controller.signal });
    }

    disconnectedCallback() {
      this.controller && this.controller.abort();
    }
  }
  customElements.define('product-details', ProductDetails);
</script>