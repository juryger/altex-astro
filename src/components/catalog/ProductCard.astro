---
export const prerender = false;

import { getTextHandler } from '../../core/helpers/text-utils';
import type { Product } from '../../core/models/product';
import { UnitOfMeasurementMetadata } from '../../core/models/unit-of-measurement';
import ProductColors from './ProductColors.astro';
import ProductPrice from './ProductPrice.astro';
import ProductPackInfo from './ProductPackInfo.astro';
import ProductQuickView from './ProductQuickView.astro';

interface Props {
  item: Product,
}

const { item } = Astro.props;

const titleAddToCart = "–í –∫–æ—Ä–∑–∏–Ω—É";

const textHandler = getTextHandler();
const productsBlobStorageUrl = `${import.meta.env.PUBLIC_BLOB_STORAGE_PRODUCTS_URL}/thumbnails`;
const unitItem = item.unit ? UnitOfMeasurementMetadata[item.unit] : UnitOfMeasurementMetadata[0];
console.log("üöÄ ~ ProductCard component ~ blob storage url %s, unitOfMeasurement: %s", productsBlobStorageUrl, unitItem.title)
---

<product-card data-id={item.id}>
  <div class="group card bg-base-300 w-auto shadow-sm px-2 py-2">
    {/* Product image with quick preivew */}
    <div>
      <ProductQuickView item={item} />
    </div>
    <div class="card-body !px-1 !py-1">
      {/* Product code */}
      <div class="flex flex-row justify-end">
        <span class="text-xs italic \">–ê—Ä—Ç–∏–∫—É–ª:</span>
        <span class="text-xs italic ml-1">{item.productCode}</span>
      </div>
      {/* Ttitle */}
      <div class="min-h-10">
        <a class="flex flex-row" href=`/catalog/products/${item.slug}`>
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="size-5 pt-1">
            <path stroke-linecap="round" stroke-linejoin="round" d="M13.19 8.688a4.5 4.5 0 0 1 1.242 7.244l-4.5 4.5a4.5 4.5 0 0 1-6.364-6.364l1.757-1.757m13.35-.622 1.757-1.757a4.5 4.5 0 0 0-6.364-6.364l-4.5 4.5a4.5 4.5 0 0 0 1.242 7.244" />
          </svg>
          <span class="card-title text-sm font-bold pl-2" title={item.title}>
            {textHandler.trimEnd(item.title, 50)} 
          </span>
        </a>
      </div>
      {/* Prices block */}
      <ProductPrice price={item.price} whsPrice1={item.whsPrice1} whsPrice2={item.whsPrice2} isDetailed={false} />
      {/* Pack qunatity details */}
      <ProductPackInfo quantityInPack={item.quantityInPack} minQuantityToBuy={item.minQuantityToBuy} unitOfMeasurementTitle={unitItem.title} />
      {/* Available colors */}
      <ProductColors productId={item.id} colors={item.colors} />
      {/* Add to Shopping Cart */}
      <button name="pc-add-to-cart" class="btn btn-active btn-primary">{titleAddToCart}</button>
    </div>
  </div>
</product-card>

<script>
  class ProductCard extends HTMLElement {
    private productId: number | undefined;
    private addToCartHandler: any | undefined;

    private onAddToCart = (productId: number) => {
      return (event: Event) => {
        const selectedColorEl =  this.querySelector('input[type=radio]:checked');
        const selectedColor = selectedColorEl ? (selectedColorEl as HTMLInputElement).value : null;
        const quntity = "1";
        alert(`Command to add product #${productId} with color ${selectedColor ?? "NA"} and count ${quntity} to shopping card.`);
      };
    }
    
    connectedCallback() {
      const checkValue =  parseInt(this.dataset.id ?? '0', 10);
      if (isNaN(checkValue)) { 
        console.warn(`~ ProductCard ~ provided value of product ID is not a number:`, this.dataset.id);
        return;
      }
      
      this.productId = checkValue;
      this.addToCartHandler = this.onAddToCart(this.productId);

      const button = this.querySelector("button[name='pc-add-to-cart']");
      console.assert(button !== null, "Cannot find button element with name: %s", "pc-add-to-cart");
      button?.addEventListener('click', this.addToCartHandler);
    }

    disconnectedCallback() {
      if (this.addToCartHandler !== undefined) {
        const button = this.querySelector("button[name='pc-add-to-cart']");
        console.assert(button !== null, "Cannot find button element with name: %s", "pc-add-to-cart");
        button?.removeEventListener('click', this.addToCartHandler);
      }
    }
  }
  customElements.define('product-card', ProductCard);
</script>